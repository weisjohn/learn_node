<html>
<head>
	<title>draggable demo</title>
	<style type="text/css">
		body {
			overflow: auto;
			height: 100%;
			width: 100%;
			background: #666666;
		}
		#ball {
			position: absolute;
			left: 0;
			top: 0;
			border-radius: 10px;
			width: 20px;
			height: 20px;
			background-color: black;
		}
	</style>
</head>
<body>
	<div id="ball"></div>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">

		// helpers for touch versus click
		var isTouch = "ontouchstart" in window;
		var InputHandler = {
			
			startEvent : isTouch ? "touchstart" : "mousedown",
			moveEvent  : isTouch ? "touchmove" : "mousemove",
			endEvent   : isTouch ? "touchend" : "mouseup",
			
			// normalize an event object generated by a select 
			mungeEvent : function(evnt) {
				 return isTouch ? evnt.originalEvent.touches[0] || evnt.originalEvent.changedTouches[0] : evnt;
			}
		};

		var delay = 0;
		if (location.hash) { 
			delay = parseInt(location.hash.split('#rtt=')[1]);
		}

		$(function() {

			var socket = io.connect(window.location.href);
			socket.on('move', function (data) {
				
				
				// update local
				setTimeout(function() { 
					console.log(data);
					
					$("#ball").css(data) 
				}, delay);
			});

			var select_delta;
			function handle_local_move(evnt) {

				// console.log('move');

				var new_location = {
					"left" : (evnt.pageX + select_delta["left"]), 
					"top" :  (evnt.pageY + select_delta["top"])
				};

				// update local
				$("#ball").css(new_location);

				// update server
				setTimeout(function() { 
					socket.emit("move", new_location);
				}, delay);
			}

			$("#ball").bind(InputHandler.startEvent, function(evnt) {
				var offset_target = $(this);
				// console.log(InputHandler.startEvent);
				// find and record the delta between where the select occurred and where the object is
				// prevent a "jut" on select of a layer
				var select_event = InputHandler.mungeEvent(evnt);
					select_delta = {
					"top" :  offset_target.offset()["top"] - select_event.pageY,
					"left" : offset_target.offset()["left"] - select_event.pageX
				};
				$("body").bind(InputHandler.moveEvent, handle_local_move);
			});

			$("body").bind(InputHandler.endEvent, function(evnt) {
				console.log(InputHandler.endEvent);
				$("body").unbind(InputHandler.moveEvent);
			});

		});
	</script>
</body>
</html>